#Moodle Swiss edu-ID authentication plugins for mobile apps

##RSD - Remote service description

The remote service description is used to list all the services available on a moodle instance.

The descriptions follow the [RSD specification](https://github.com/BLC-HTWChur/rsd2-specification/).

The services list is collected and stored by the Swiss edu-ID Service and distributed to the third party apps through the Swiss edu-ID mobile app.

This is an example in JSON of the service output.

```javascript
{
	"engineName": "Moodle29 Dev Platform",
	"engineLink": "",
	"homePageLink": "http://localhost/moodle/",
	"apis": {
		"moodle_mobile_app": {
			"apiVersion": "2.9.4+ (Build: 20160225)",
			"apiLink": "webservice/",
			"transport": [
				"rest",
				"soap"
			]
		},
		"uniapp_mobile": {
			"apiVersion": "2.9.4+ (Build: 20160225)",
			"apiLink": "webservice/",
			"transport": [
				"rest",
				"soap"
			]
		}
	}
}
```

The RSD does not contain function definitions. These can be found in the official documentation.
The apis entry keys are the service shortnames and are used as references when generating the app tokens.
The transport protocol is indicated but the RSD is not complete enough to illustrate how to perform a request.
For this reason the developers should consult the official Moodle documentation.

Currently available on [github](https://github.com/arael/moodle_rsd)


##eduid authorization provider

The eduid authorization provider is the auth plugin for Moodle which generates the access and the app token.
The access token is used to establish the long lasting token which is used to request one or more app tokens.
The access tokens are tied to the user authentication and the app tokens are tied to the moodle external services access and usage.
The access token can be used to generate app tokens or to refresh them when they expire.
The access token itself can expire. When this happens a new authentication process is started and if successful the access token is renewed.

Currently the eduid authorization provider has two endpoints:

1. get_service_access.php
2. get_app_token.php


### Service access token cycle
The Swiss edu-ID app requests a user to be authenticated by the Swiss edu-ID Service.
When the user is authenticated a short lived token called grant code is generated by the Swiss edu-ID Service it passed to the Swiss edu-ID app.
The Swiss edu-ID app contacts the Service provider through the get_service_access endpoint and sends the grant code.
The grant code is passed to the get_service_access script as HTTP header Authorization field.
The grant code is used by the eduid authorization provider to fetch information about the user from the edu-ID Service.
If the grant code is valid the user information are sent as response.
If it is the first access for the user the user information are also used to add the user to the moodle database.
The user information is also used to generate an access token.
The access token and its expiration time are then passed as response to the Swiss edu-ID app.

### App token cycle
After the access token is received the Swiss edu-ID app can ask for an app token.
The app token is used to issue service requests from the Service provider.
The get_app_token endpoint is used to generate the app token. It receives the access token as Authorization HTTP header field and the service shortname as query string.
If the access token is still valid it is used to identify the user and generate the app token.
The app token and the expiration time are then passed as a response to the Swiss edu-ID app.


Currently available on [github](https://github.com/arael/moodle_eduid)
